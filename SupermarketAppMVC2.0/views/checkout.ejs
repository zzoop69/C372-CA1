<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <title>Checkout</title>
  <style>
      body {
        font-weight: bold;
        background-image: url('/images/supermarket3.jpg');
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        min-height: 100vh;
        color: #fff;
      }
      .bg-overlay { background-color: rgba(255,255,255,0.75); padding: 40px 0; }
      .auth-card { max-width: 720px; margin: 0 auto; }
      .products-overlay {
        background-color: rgba(0, 0, 0, 0.555);
        padding: 24px;
        border-radius: 8px;
        margin-bottom: 24px;
      }
      .products-overlay .text-center h2, .products-overlay p { color: #fff; }
      .products-overlay { color: #fff; }
      .products-overlay h2, .products-overlay p, .products-overlay .small { color: #fff; }
      .list-group { background: transparent; }
      .products-overlay .list-group-item { background: #ffffff; color: #000000; border: 1px solid rgba(0,0,0,0.06); }
      .products-overlay .list-group-item * { color: #000000 !important; }
  </style>
</head>
<body>
  <%- include('partials/navbar', { user: user, cart: cart }) %>

  <div class="container mt-4">
    <div class="products-overlay">
      <h2>Checkout</h2>
      <div id="checkoutErrors"></div>
      <% const cartItems = cart || []; %>
      <% if (cartItems.length === 0) { %>
        <p>Your cart is empty.</p>
        <a href="/shopping" class="btn btn-secondary">Back to Shopping</a>
      <% } else { %>
        <ul class="list-group mb-3">
          <% let total = 0; %>
          <% cartItems.forEach(item => { %>
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <div>
                <strong><%= item.productName %></strong>
                <div class="small">Qty: <%= item.quantity %> × $<%= item.price.toFixed(2) %></div>
              </div>
              <div>$<%= (item.price * item.quantity).toFixed(2) %></div>
            </li>
            <% total += item.price * item.quantity; %>
          <% }); %>
        </ul>
        <h4>Total: $<%= total.toFixed(2) %></h4>

        <div class="mb-3">
          <a href="/cart" class="btn btn-secondary mt-1">Back to Cart</a>
          <a href="/shopping" class="btn btn-primary mt-1 ms-2">Continue Shopping</a>
        </div>

        <!-- Final confirm purchase form: submits selected items stored in session.selectedCart -->
        <form id="confirmForm" action="/confirm-checkout" method="POST">
          <button id="confirmBtn" type="button" class="btn btn-success mt-3">Confirm Purchase</button>
        </form>

        <!-- Confirmation Modal -->
        <div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-lg">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Confirm Your Purchase</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <p>Please review your order before confirming.</p>
                <div id="confirmSummary">
                  <!-- Summary list will be injected here -->
                </div>
                <div class="mt-3">
                  <strong>Total: $<span id="confirmTotal">0.00</span></strong>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button id="confirmPurchaseBtn" type="button" class="btn btn-success">Yes, Confirm Purchase</button>
              </div>
            </div>
          </div>
        </div>
      <% } %>
    </div>
  </div>
</body>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  (function () {
    // Safely embed JSON as a string to avoid template/parser issues and XSS
    const cart = JSON.parse('<%- (JSON.stringify(cartItems || [])).replace(/</g, "\\u003c") %>');
    const confirmBtn = document.getElementById('confirmBtn');
    const confirmModalEl = document.getElementById('confirmModal');
    const confirmSummary = document.getElementById('confirmSummary');
    const confirmTotalEl = document.getElementById('confirmTotal');
    const confirmPurchaseBtn = document.getElementById('confirmPurchaseBtn');
    const confirmForm = document.getElementById('confirmForm');
    const bsModal = new bootstrap.Modal(confirmModalEl);

    function renderSummary() {
      confirmSummary.innerHTML = '';
      let total = 0;
      if (!cart || cart.length === 0) {
        confirmSummary.innerHTML = '<p>Your cart is empty.</p>';
      } else {
        const ul = document.createElement('ul');
        ul.className = 'list-group';
        cart.forEach(item => {
          const li = document.createElement('li');
          li.className = 'list-group-item d-flex justify-content-between align-items-center';
          const left = document.createElement('div');
          left.innerHTML = `<strong>${item.productName}</strong><div class="small">Qty: ${item.quantity} × $${Number(item.price).toFixed(2)}</div>`;
          const right = document.createElement('div');
          const rowTotal = Number(item.price) * Number(item.quantity);
          right.textContent = `$${rowTotal.toFixed(2)}`;
          li.appendChild(left);
          li.appendChild(right);
          ul.appendChild(li);
          total += rowTotal;
        });
        confirmSummary.appendChild(ul);
      }
      confirmTotalEl.textContent = (total || 0).toFixed(2);
    }

    if (confirmBtn) {
      confirmBtn.addEventListener('click', function (e) {
        e.preventDefault();
        // First validate against current stock
        fetch('/cart/validate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
          body: JSON.stringify({ items: cart.map(it => ({ id: it.id, quantity: it.quantity })) })
        }).then(r => r.json()).then(data => {
          const errContainer = document.getElementById('checkoutErrors');
          errContainer.innerHTML = '';
          if (!data || !data.ok) {
            // show errors if any
            if (data && data.insufficient && data.insufficient.length > 0) {
              const list = document.createElement('div');
              list.className = 'alert alert-danger';
              list.innerHTML = '<strong>Cannot proceed to checkout. Insufficient stock for these items:</strong><ul class="mb-0"></ul>';
              const ul = list.querySelector('ul');
              data.insufficient.forEach(it => {
                const li = document.createElement('li');
                li.textContent = `${it.productName} — requested: ${it.requested}, available: ${it.available}`;
                ul.appendChild(li);
              });
              errContainer.appendChild(list);
            } else if (data && data.error) {
              const alert = document.createElement('div');
              alert.className = 'alert alert-danger';
              alert.textContent = 'Unable to validate cart: ' + data.error;
              errContainer.appendChild(alert);
            }
            // Do not open modal if not ok
            return;
          }
          // OK to proceed
          renderSummary();
          bsModal.show();
        }).catch(err => {
          console.error('Validation error', err);
          const errContainer = document.getElementById('checkoutErrors');
          errContainer.innerHTML = '<div class="alert alert-danger">Error validating cart before checkout. Please try again later.</div>';
        });
      });
    }

    if (confirmPurchaseBtn) {
      confirmPurchaseBtn.addEventListener('click', function () {
        // submit the original form to proceed with payment/confirmation
        if (confirmForm) confirmForm.submit();
      });
    }
  })();
</script>
</html>
