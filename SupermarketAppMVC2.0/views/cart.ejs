<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Your Cart</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
      body {
        font-weight: bold;
      }
      h2, h4{
        color: white;
      }
      body {
        background-image: url('/images/supermarket3.jpg');
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        min-height: 100vh;
      }
      .bg-overlay { background-color: rgba(255,255,255,0.75); padding: 40px 0; }
      .auth-card { max-width: 720px; margin: 0 auto; }
      .products-overlay {
        background-color: rgba(0, 0, 0, 0.555);
        padding: 24px;
        border-radius: 8px;
        margin-bottom: 24px;
      }
      .products-overlay .text-center h2, .products-overlay p { color: #fff; }
    </style>
</head>
<body>
  <%- include('partials/navbar', { user: user, cart: cart }) %>
  <!-- Cart Content -->
  <div class="container">
    <div class="products-overlay">
    <h2 class="mt-4">Shopping Cart</h2>
    <% if (!cart || cart.length === 0) { %>
      <p>Your cart is empty.</p>
    <% } else { %>
      <form action="/checkout" method="POST">
        <table class="table table-bordered">
          <thead>
            <tr>
              <th class="text-center"><input type="checkbox" id="select-all" title="Select all"></th>
              <th>Product</th>
              <th>Image</th>
              <th>Price</th>
              <th>Quantity</th>
              <th>Total</th>
              <th>Add/Minus/Remove</th>
            </tr>
          </thead>
          <tbody>
            <% let total = 0; %>
            <% for (let i = 0; i < cart.length; i++) { const item = cart[i]; %>
              <tr data-id="<%= item.id %>">
                <td class="align-middle text-center">
                  <input type="checkbox" name="selected" value="<%= item.id %>" data-price="<%= item.price %>" data-qty="<%= item.quantity %>" id="item-<%= item.id %>">
                </td>
                <td class="align-middle"><%= item.productName %></td>
                <td class="align-middle"><img src="/images/<%= item.image %>" width="80" class="img-thumbnail"></td>
                <td class="align-middle">$<%= item.price.toFixed(2) %></td>
                <td class="align-middle text-center"><span id="qty-<%= item.id %>"><%= item.quantity %></span></td>
                <td class="align-middle">$<span id="rowtotal-<%= item.id %>"><%= (item.price * item.quantity).toFixed(2) %></span></td>
                <td class="align-middle">
                  <div class="d-flex gap-1">
                    <form action="/cart/decrease/<%= item.id %>" method="POST" style="display:inline">
                      <button type="submit" class="btn btn-sm btn-outline-secondary">-</button>
                    </form>
                    <form action="/cart/increase/<%= item.id %>" method="POST" style="display:inline">
                      <button type="submit" class="btn btn-sm btn-outline-secondary">+</button>
                    </form>
                    <form action="/cart/remove/<%= item.id %>" method="POST" style="display:inline">
                      <button type="submit" class="btn btn-sm btn-outline-danger">Remove</button>
                    </form>
                  </div>
                </td>
              </tr>
              <% total += item.price * item.quantity; %>
            <% } %>
          </tbody>
        </table>

        <h4>Total: $<span id="cart-total"><%= total.toFixed(2) %></span></h4>

        <div class="mt-2">
          <strong id="selected-total" class="text-white">Selected items: $0.00</strong>
        </div>

        <div class="mt-4 d-flex gap-2">
          <a href="/shopping" class="btn btn-secondary">Back to Shopping</a>
          <button type="button" class="btn btn-danger" id="clear-cart-btn">Clear Cart</button>
          <button type="submit" class="btn btn-success" id="proceed-button">Proceed to Checkout (selected)</button>
        </div>
      </form>
    <% } %>
    </div>
  </div>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const selectAll = document.getElementById('select-all');
      const selectedTotalEl = document.getElementById('selected-total');
      const cartTotalEl = document.getElementById('cart-total');
      const form = document.querySelector('form[action="/checkout"]');

      function getCheckboxes() {
        return Array.from(document.querySelectorAll('input[name="selected"]'));
      }

      function updateSelectedTotal() {
        const checkboxes = getCheckboxes();
        let sum = 0;
        checkboxes.forEach(cb => {
          if (cb.checked) {
            const price = parseFloat(cb.getAttribute('data-price')) || 0;
            const qty = parseInt(cb.getAttribute('data-qty')) || 0;
            sum += price * qty;
          }
        });
        selectedTotalEl.style.fontSize = '1.5rem';
        selectedTotalEl.style.fontWeight = '700';
        selectedTotalEl.textContent = 'Selected items: $' + sum.toFixed(2);
      }

      // Toggle all checkboxes
      if (selectAll) {
        selectAll.addEventListener('change', function () {
          const checkboxes = getCheckboxes();
          checkboxes.forEach(cb => cb.checked = selectAll.checked);
          updateSelectedTotal();
        });
      }

      // delegate checkbox change
      document.addEventListener('change', function (e) {
        if (e.target && e.target.matches('input[name="selected"]')) {
          const checkboxes = getCheckboxes();
          const allChecked = checkboxes.length > 0 && checkboxes.every(c => c.checked);
          if (selectAll) selectAll.checked = allChecked;
          updateSelectedTotal();
        }
      });

      // AJAX helper to post and update DOM
      function postAction(url) {
        return fetch(url, { method: 'POST', headers: { 'Accept': 'application/json' } })
          .then(async r => {
            const ct = r.headers.get('content-type') || '';
            if (!r.ok) {
              if (ct.includes('application/json')) {
                const data = await r.json();
                throw new Error(data.error || 'Request failed');
              }
              const txt = await r.text();
              throw new Error(txt || 'Request failed');
            }
            if (ct.includes('application/json')) return r.json();
            return { cart: [] };
          });
      }

      // handle increase/decrease/remove via AJAX
      document.querySelectorAll('form[action^="/cart/"]').forEach(f => {
        f.addEventListener('submit', function (ev) {
          ev.preventDefault();
          const url = f.getAttribute('action');
          postAction(url).then(data => {
            const cart = data.cart || [];
            const cartTotal = typeof data.cartTotal !== 'undefined' ? data.cartTotal : null;

            // Update or remove rows
            document.querySelectorAll('tr[data-id]').forEach(row => {
              const rid = Number(row.getAttribute('data-id'));
              const item = cart.find(it => it.id === rid);
              if (item) {
                const qtyEl = document.getElementById('qty-' + item.id);
                const rowTotalEl = document.getElementById('rowtotal-' + item.id);
                const cb = row.querySelector('input[name="selected"]');
                if (qtyEl) qtyEl.textContent = item.quantity;
                if (rowTotalEl) rowTotalEl.textContent = (item.price * item.quantity).toFixed(2);
                if (cb) cb.setAttribute('data-qty', item.quantity);
              } else {
                row.remove();
              }
            });

            // update cart total display
            if (cartTotalEl && cartTotal !== null) cartTotalEl.textContent = cartTotal.toFixed(2);

            // update selected total
            updateSelectedTotal();
          }).catch(err => { console.error('Error updating cart', err); alert(err && err.message ? err.message : 'Error updating cart'); });
        });
      });

      // Clear cart via AJAX
      const clearBtn = document.getElementById('clear-cart-btn');
      if (clearBtn) {
        clearBtn.addEventListener('click', function (ev) {
          if (!confirm('Are you sure you want to clear all items from your cart?')) return;
          postAction('/cart/clear').then(data => {
            // remove all rows
            document.querySelectorAll('tr[data-id]').forEach(r => r.remove());
            // reset totals and selected total
            if (cartTotalEl) cartTotalEl.textContent = (data && data.cartTotal) ? Number(data.cartTotal).toFixed(2) : '0.00';
            const selectedTotalEl = document.getElementById('selected-total');
            if (selectedTotalEl) selectedTotalEl.textContent = 'Selected items: $0.00';
            // optionally show feedback
            alert('Cart cleared.');
          }).catch(err => { console.error('Error clearing cart', err); alert('Unable to clear cart'); });
        });
      }

      // Prevent submitting with no selection
      if (form) {
        form.addEventListener('submit', function (e) {
          const anyChecked = getCheckboxes().some(c => c.checked);
          if (!anyChecked) {
            e.preventDefault();
            alert('Please select at least one item to proceed to checkout.');
            return false;
          }
          return true;
        });
      }

      // initialize totals
      updateSelectedTotal();
    });
  </script>
</body>
</html>
