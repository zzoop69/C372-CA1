<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <title>Admin - Orders</title>
  <style>
    body { background-image: url('/images/supermarket3.jpg'); background-size: cover; background-position:center; }
    .overlay { background: rgba(0,0,0,0.6); padding: 24px; color: #fff; min-height: 100vh; }
    table thead th { color: #fff; }
  </style>
</head>
<body>
  <%- include('partials/adminnavbar') %>

  <div class="container overlay mt-4">
    <h2>Orders Management</h2>

    <form class="row g-2 mb-3" method="GET" action="/admin/orders">
      <div class="col-md-3">
        <label class="form-label">Status</label>
        <select name="status" class="form-select">
          <option value="">All</option>
          <option value="completed" <%= filters && filters.status === 'completed' ? 'selected' : '' %>>Completed</option>
          <option value="pending" <%= filters && filters.status === 'pending' ? 'selected' : '' %>>Pending</option>
          <option value="cancelled" <%= filters && filters.status === 'cancelled' ? 'selected' : '' %>>Cancelled</option>
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label">Start Date</label>
        <input type="date" name="startDate" class="form-control" value="<%= filters && filters.startDate ? filters.startDate : '' %>">
      </div>
      <div class="col-md-3">
        <label class="form-label">End Date</label>
        <input type="date" name="endDate" class="form-control" value="<%= filters && filters.endDate ? filters.endDate : '' %>">
      </div>
      <div class="col-md-3">
        <label class="form-label">Customer</label>
        <input type="text" name="customer" class="form-control" placeholder="Name or email" value="<%= filters && filters.customer ? filters.customer : '' %>">
      </div>
      <div class="col-12 text-end mt-2">
        <button class="btn btn-secondary" type="submit">Filter</button>
        <a href="/admin/orders" class="btn btn-light">Reset</a>
      </div>
    </form>

    <% if (!orders || orders.length === 0) { %>
      <div class="alert alert-info">No orders found.</div>
    <% } else { %>
      <div class="table-responsive">
        <table class="table table-hover table-dark table-striped align-middle">
          <thead>
            <tr>
              <th>Order ID</th>
              <th>Date</th>
              <th>Status</th>
              <th>Customer</th>
              <th>Email</th>
              <th>Shipping Address</th>
              <th>Items</th>
              <th>Total</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <% orders.forEach(order => { %>
              <tr>
                <td><%= order.id %></td>
                <td><%= new Date(order.order_date).toLocaleString() %></td>
                <td><%= order.status || 'n/a' %></td>
                <td><%= order.customerName || 'Guest' %></td>
                <td><%= order.customerEmail || '-' %></td>
                <td style="max-width:220px; white-space:normal;"><%= order.shippingAddress || '-' %></td>
                <td>
                  <ul class="mb-0">
                    <% order.items.forEach(it => { %>
                      <li><%= it.productName %> x <%= it.quantity %> (@ $<%= Number(it.price).toFixed(2) %>)</li>
                    <% }) %>
                  </ul>
                </td>
                <td>$<%= Number(order.total_amount).toFixed(2) %></td>
                <td>
                  <form action="/admin/orders/<%= order.id %>/status" method="POST" class="mb-1">
                    <div class="input-group">
                      <select name="status" class="form-select form-select-sm">
                        <option value="pending" <%= order.status === 'pending' ? 'selected' : '' %>>Pending</option>
                        <option value="completed" <%= order.status === 'completed' ? 'selected' : '' %>>Completed</option>
                        <option value="cancelled" <%= order.status === 'cancelled' ? 'selected' : '' %>>Cancelled</option>
                      </select>
                      <button class="btn btn-sm btn-primary" type="submit">Update</button>
                    </div>
                  </form>
                  <form action="/admin/orders/<%= order.id %>/cancel" method="POST" onsubmit="return confirm('Cancel this order?');">
                    <button class="btn btn-sm btn-danger mb-1" type="submit">Cancel</button>
                  </form>
                  <% if (order.user_id) { %>
                    <button class="btn btn-sm btn-info" type="button" onclick="viewCustomer('<%= order.user_id %>')">View Customer</button>
                  <% } %>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
    <% } %>
  </div>

  <!-- Customer Details Modal -->
  <div class="modal fade" id="customerModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Customer Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="customerContent">Loading...</div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const customerModal = new bootstrap.Modal(document.getElementById('customerModal'));
    function viewCustomer(id) {
      fetch('/admin/customer/' + id, { headers: { 'Accept': 'application/json' } })
        .then(r => r.json())
        .then(data => {
          if (data && data.customer) {
            const c = data.customer;
            document.getElementById('customerContent').innerHTML = `<p><strong>${c.username}</strong> (${c.email})</p><p>Address: ${c.address || '-'} </p><p>Contact: ${c.contact || '-'}</p><p>Role: ${c.role}</p>`;
            customerModal.show();
          } else {
            document.getElementById('customerContent').innerText = 'No details available';
            customerModal.show();
          }
        }).catch(err => {
          document.getElementById('customerContent').innerText = 'Error loading customer';
          customerModal.show();
        });
    }
  </script>
</body>
</html>
