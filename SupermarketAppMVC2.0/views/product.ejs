<!-- product.ejs -->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <title>Supermarket App</title>
    <style>
      body {
        font-weight: bold;
      }
      body {
        background-image: url('/images/supermarket3.jpg');
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        min-height: 100vh;
      }
      .bg-overlay { background-color: rgba(255,255,255,0.75); padding: 40px 0; }
      .auth-card { max-width: 720px; margin: 0 auto; }
      .products-overlay {
        background-color: rgba(0, 0, 0, 0.555);
        padding: 24px;
        border-radius: 8px;
        margin-bottom: 24px;
      }
      .products-overlay .text-center h2, .products-overlay p { color: #fff; }
    </style>
</head>
<body>
    <%- include('partials/navbar', { user: user, cart: cart }) %>

    <div class="container">
      <div class="products-overlay">
        <p>Welcome, <%= user.username %> (<%= user.role %>)</p>
        <br>
        <div class="text-center"><h2>Product Details</h2></div>
        <br>

        <% if (product) { %>
          <div class="row align-items-center">
            <div class="col-md-6 text-center mb-3">
              <img src="/images/<%= product.image %>" alt="<%= product.productName %>" class="img-fluid rounded" style="max-height:320px; object-fit:cover;">
            </div>
              <div class="col-md-6">
                <h3 class="text-white"><%= product.productName %></h3>
                <p class="text-white">Available: <strong><%= product.quantity %></strong></p>
                <p class="text-white">Price: <strong>$<%= product.price.toFixed(2) %></strong></p>
              <p><%= product.description || '' %></p>

              <div class="mt-3">
                <% if (user && user.role === 'admin') { %>
                  <a href="/updateProduct/<%= product.id %>" class="btn btn-warning me-2">Edit Product</a>
                  <a href="/deleteProduct/<%= product.id %>" class="btn btn-danger" onclick="return confirm('Are you sure you want to delete this product?')">Delete Product</a>
                <% } else { %>
                  <form id="product-add-form" action="/add-to-cart/<%= product.id %>" method="POST" class="product-add-form d-flex align-items-center">
                    <input type="hidden" name="id" value="<%= product.id %>">
                    <input type="hidden" name="quantity" id="product-quantity-hidden" value="1">
                    <input id="product-quantity" type="number" name="qty" min="1" max="<%= product.quantity %>" value="1" class="form-control me-2" style="width:120px;">
                    <% if (product.quantity > 0) { %>
                      <button type="submit" class="btn btn-primary">Add to cart</button>
                    <% } else { %>
                      <button type="button" class="btn btn-secondary" disabled>Out of stock</button>
                    <% } %>
                  </form>
                <% } %>
              </div>

              <div class="mt-3">
                <% if (user.role === "admin") { %>
                  <a href="/inventory" class="btn btn-outline-light">Back</a>
                <% } else { %>
                  <a href="/shopping" class="btn btn-outline-light">Back</a>
                <% } %>
              </div>
            </div>
          </div>
        <% } else { %>
          <p>No product found.</p>
        <% } %>

      </div>
    </div>
    <script>
      document.addEventListener('DOMContentLoaded', function () {
        const form = document.getElementById('product-add-form');
        if (!form) return;
        const numInput = document.getElementById('product-quantity');
        const hidden = document.getElementById('product-quantity-hidden');
        const max = parseInt(numInput ? numInput.max : '0', 10) || 0;

        numInput.addEventListener('change', function () { hidden.value = this.value; });

        form.addEventListener('submit', function (e) {
          e.preventDefault();
          const val = parseInt(numInput.value || '0', 10) || 0;
          if (val > max) {
            alert('Not enough stock. Only ' + max + ' items available.');
            numInput.value = String(max);
            hidden.value = String(max);
            return;
          }
          hidden.value = String(val);

          const action = form.getAttribute('action');
          // use URL-encoded body so server parses it with express.urlencoded
          const params = new URLSearchParams();
          params.append('quantity', hidden.value || '1');
          fetch(action, { method: 'POST', headers: { 'Accept': 'application/json', 'Content-Type': 'application/x-www-form-urlencoded' }, body: params.toString() })
            .then(async resp => {
              const ct = resp.headers.get('content-type') || '';
              console.log('Product add-to-cart response', resp.status, ct);
              if (!resp.ok) {
                if (ct.includes('application/json')) {
                  const data = await resp.json();
                  alert(data.error || 'Failed to add to cart');
                } else {
                  const txt = await resp.text();
                  console.warn('Non-JSON error body:', txt);
                  alert('Failed to add to cart: ' + (txt || resp.status));
                }
                return;
              }
              if (ct.includes('application/json')) {
                const data = await resp.json();
                const badge = document.querySelector('.navbar .badge');
                if (badge && data.cart) {
                  const totalItems = (data.cart || []).reduce((s, it) => s + (it.quantity || 0), 0);
                  badge.textContent = totalItems;
                }
              } else {
                window.location.reload();
              }
            }).catch(err => { console.error(err); alert('Error adding to cart'); });
        });
      });
    </script>
    
</body>
</html>
